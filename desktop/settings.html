<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - Windows Whisper</title>
    <link rel="stylesheet" href="/src/styles.css" />
    <style>
      body {
        background: var(--bg-secondary);
        padding: 24px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div
      class="settings-panel"
      style="width: 100%; height: 100%; box-shadow: none; padding: 0"
    >
      <h2 style="margin-top: 0">Configuration</h2>

      <div class="setting-group">
        <label class="setting-label">Global Hotkey</label>
        <input
          type="text"
          id="hotkey-input"
          class="setting-input hotkey-input"
          readonly
          value="Ctrl+Shift+Space"
        />
        <p
          style="
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: center;
          "
        >
          Click to record new hotkey
        </p>
      </div>

      <div class="setting-group">
        <label class="setting-label">API Key (Cloudflare)</label>
        <input
          type="password"
          id="api-key-input"
          class="setting-input"
          placeholder="Enter your Worker API Key"
        />
      </div>

      <div class="setting-group">
        <label class="setting-label">Worker URL</label>
        <input
          type="text"
          id="api-url-input"
          class="setting-input"
          placeholder="https://..."
        />
      </div>

      <div
        style="
          display: flex;
          justify-content: flex-end;
          gap: 8px;
          margin-top: auto;
        "
      >
        <button id="save-btn" class="btn btn-primary">Save Changes</button>
      </div>
    </div>

    <script type="module">
      import { invoke } from "@tauri-apps/api/core";
      import { getCurrentWindow } from "@tauri-apps/api/window";

      const hotkeyInput = document.getElementById("hotkey-input");
      const apiKeyInput = document.getElementById("api-key-input");
      const apiUrlInput = document.getElementById("api-url-input");
      const saveBtn = document.getElementById("save-btn");

      let currentHotkey = "Ctrl+Shift+Space";
      let isRecordingHotkey = false;

      // Load current settings
      async function loadSettings() {
        try {
          const settings = await invoke("get_settings");
          currentHotkey = settings.hotkey;
          hotkeyInput.value = currentHotkey;
          apiKeyInput.value = settings.api_key;
          apiUrlInput.value = settings.api_url;
        } catch (e) {
          console.error("Failed to load settings:", e);
        }
      }

      // Hotkey recording logic
      hotkeyInput.addEventListener("click", () => {
        isRecordingHotkey = true;
        hotkeyInput.classList.add("listening");
        hotkeyInput.value = "Press keys...";
      });

      hotkeyInput.addEventListener("keydown", (e) => {
        if (!isRecordingHotkey) return;
        e.preventDefault();

        const modifiers = [];
        if (e.ctrlKey) modifiers.push("Ctrl");
        if (e.shiftKey) modifiers.push("Shift");
        if (e.altKey) modifiers.push("Alt");
        if (e.metaKey) modifiers.push("Super");

        let key = e.key.toUpperCase();
        if (
          key === "CONTROL" ||
          key === "SHIFT" ||
          key === "ALT" ||
          key === "META"
        )
          return;
        if (key === " ") key = "Space";

        const hotkey = [...modifiers, key].join("+");
        hotkeyInput.value = hotkey;
        currentHotkey = hotkey;

        isRecordingHotkey = false;
        hotkeyInput.classList.remove("listening");
      });

      // Save settings
      saveBtn.addEventListener("click", async () => {
        try {
          await invoke("save_settings", {
            settings: {
              hotkey: currentHotkey,
              api_key: apiKeyInput.value,
              api_url: apiUrlInput.value,
            },
          });

          await getCurrentWindow().close();
        } catch (e) {
          alert("Failed to save settings: " + e);
        }
      });

      loadSettings();
    </script>
  </body>
</html>
